---
output:
  pdf_document: default
  html_document: default
---
# Analysis of the Triboro line

## Requirements

### Libraries
```{r, message=FALSE}
library(tidyverse)
```

### Files
```{r, message=FALSE}
nys_od <- readr::read_csv('data/ny_od_main_JT00_2019.csv')
nyc_nta_borders <- sf::st_read('data/nyc_2010_nta_borders.geojson')
nyc_nta_tract_equiv <- readxl::read_xlsx('data/nyc_2010_census_tract_nta_equiv.xlsx')

subway_lines <- readr::read_csv('data/nta-subway-lines.csv')
subway_times <- readr::read_csv('data/nta-subway-times.csv')
driving_times <- readr::read_csv('data/nta-driving-times.csv')
walking_times <- readr::read_csv('data/nta-walking-times.csv')
```

### Data
```{r, message=FALSE}
bk_name <- "Brooklyn"
bk_county_code <- "047"
bk_parks <- "BK99"

bk_nta_border <- nyc_nta_borders %>%
  dplyr::filter(BoroName == bk_name)  %>%
  dplyr::filter(NTACode != bk_parks) %>%
  dplyr::select("NTACode")

bk_nta_tract_equiv <- nyc_nta_tract_equiv %>%
  dplyr::filter(borough_name == bk_name) %>%
  dplyr::filter(nta_code != bk_parks) %>%
  dplyr::rename(tract = census_tract) %>%
  dplyr::select("tract", "nta_code")

od <- nys_od %>%
  dplyr::filter(
    stringr::str_sub(as.character(w_geocode), 3, 5) == bk_county_code &
    stringr::str_sub(as.character(h_geocode), 3, 5) == bk_county_code 
  ) %>%
  dplyr::mutate(
   w_tract = stringr::str_sub(as.character(w_geocode), 6, 11)
  ) %>%
  dplyr::mutate(
   h_tract = stringr::str_sub(as.character(h_geocode), 6, 11)
  ) %>%
  dplyr::select("w_tract", "h_tract", "S000") %>%
  dplyr::left_join(bk_nta_tract_equiv, c("w_tract" = "tract")) %>%
  dplyr::rename(w_nta_code = nta_code) %>%
  dplyr::left_join(bk_nta_tract_equiv, c("h_tract" = "tract")) %>%
  dplyr::rename(h_nta_code = nta_code) %>%
  dplyr::select("h_nta_code", "w_nta_code", "S000") %>%
  dplyr::filter(w_nta_code != bk_parks & h_nta_code != bk_parks) 
``` 

TODO: Resolve orphan code
subway_lines <- subway_lines %>%
  dplyr::mutate(
    log_S000 = log(S000)
  )

## Exploratory data analysis

### Distribution of job counts
```{r, message = FALSE}
job_counts <- od %>%
  dplyr::group_by(w_nta_code) %>%
  dplyr::summarise(
    S000 = sum(S000)
  ) %>% 
  unique() %>%
  mutate(
    log_S000 = log(S000)
  )
```

Original
```{r, message=FALSE}
ggplot(job_counts) +
  geom_histogram(aes(x = S000), fill = "steelblue", color = "grey", bins = "30")
```

Natural log  
```{r, message=FALSE}
ggplot(job_counts) +
  geom_histogram(aes(x = log_S000), fill = "steelblue", color = "grey", bins = "30")
```

### Distribution of commute counts
Original
```{r, message = FALSE}
commute_counts <- subway_lines %>%
  dplyr::select(trip, S000) %>%
  dplyr::mutate(
    log_S000 = log(S000)
  )
```


```{r}
ggplot(commute_counts) +
  geom_histogram(aes(x = S000), fill = "steelblue", color = "grey", binwidth = 30)
```

Natural log
```{r}
ggplot(data = commute_counts) +
  geom_histogram(aes(x = log_S000), bins = 30, fill = "steelblue", color = "grey")
```

### Number of subway lines and commute count
Original

Transformed

### Subway Transit time and commute count
Original

Transformed

### Driving in traffic time and commute count
Original

Transformed

### Walking time and commute count

Original

Transformed

## Regression of Subway, Driving, and walking

### Subway model

### Driving

### Walking

### Multiple linear regression for all three factors

### Equations plotted for all factors
Along all axis

Cut to most pivotal times (10 to 50 minutes)
Table of values at 10, 25, 50

## Auto Correlation of Subway, Driving, and Walking


### Global Moran's I

#### Subway
Statistic
Plot 

#### Driving
Statisic
Plot 

#### Walking
Statustic
Plot

### LISA

#### Driving
Statistic 
Plot with major roadways overlayed

#### Walking
Statistic
Plot of local area

#### Subway
Statistic 
Plot with subway lines

#### Network autocorrelation

#### Visualization of network

#### Visualization of network's complement

#### Global Moran's I

#### LISA
Plot by coloring desire lines